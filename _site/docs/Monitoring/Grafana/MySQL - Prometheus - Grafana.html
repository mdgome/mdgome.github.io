<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MySQL, Prometheus, Grafana Install | Your awesome title</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="MySQL, Prometheus, Grafana Install" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<link rel="canonical" href="http://localhost:4000/docs/Monitoring/Grafana/MySQL%20-%20Prometheus%20-%20Grafana.html" />
<meta property="og:url" content="http://localhost:4000/docs/Monitoring/Grafana/MySQL%20-%20Prometheus%20-%20Grafana.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MySQL, Prometheus, Grafana Install" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"MySQL, Prometheus, Grafana Install","url":"http://localhost:4000/docs/Monitoring/Grafana/MySQL%20-%20Prometheus%20-%20Grafana.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/docs/Monitoring/Grafana/Grafana.html">Grafana</a><a class="page-link" href="/docs/Monitoring">Monitoring</a><a class="page-link" href="/docs/Monitoring/Grafana/MySQL%20-%20Prometheus%20-%20Grafana.html">MySQL, Prometheus, Grafana Install</a><a class="page-link" href="/docs/Monitoring/Grafana/SQL%20Server%20Prometheus.html">SQL Server(MSSQL), Prometheus, Grafana Install</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <details open="">
  <summary class="text-delta">
    목차
  </summary>
</details>

<h1 id="mysql-서버의-osdb-지표를-prometheus-grafana를-활용하여-모니터링">MySQL 서버의 OS/DB 지표를 Prometheus-Grafana를 활용하여 모니터링</h1>

<h2 id="개요">개요</h2>
<p>MySQL OS 지표와 DB 지표를 node_exporter, mysqld_exporter를 이용하여 수집하며, <br />
Prometheus - Grafana를 사용하여 모니터링 하기 위하여 스크립트 기반으로 문서 작성</p>
<ul>
  <li><a href="https://grafana.com/grafana/dashboards/7362-mysql-overview/">MySQL 대시보드</a></li>
  <li><a href="https://prometheus.io/docs/guides/node-exporter/">node_exporter Offical Guides</a></li>
  <li><a href="https://github.com/prometheus/node_exporter">node_exporter Github</a></li>
  <li><a href="https://github.com/prometheus/mysqld_exporter">mysqld_exporter Github</a>
    <h2 id="상황">상황</h2>
  </li>
  <li>서버는 IDC에 위치한 <strong>On-premisse</strong> Server로 OS에 직접 Agent를 설치해야 하는 상황</li>
  <li>Linux Server 는 AD 가입한 서버와 단일 서버(AD 미가입) 서버가 혼재되어 있는 상황</li>
  <li>단일 서버 OS 계정은 Local 계정으로 System Engineer와 협의는 불 필요</li>
  <li>AD 가입 서버는 정책으로 Group이 새로 생겨 System Engineer와 협의 후 보조 그룹을 생성하여 계정에 추가
    <h2 id="version-정보">Version 정보</h2>
  </li>
  <li>MySQL: 5.7.21</li>
  <li>OS: CentOS 7.9</li>
  <li>Kernel: 3.10.0</li>
  <li>OS Bit: 64Bit</li>
</ul>

<hr />
<blockquote>
  <p>테스트 용도로 Grafana 서버를 구성하며 실제 Grafana는 외부 부서에서 제공하는 서비스 사용</p>
  <h2 id="grafana-install">Grafana Install</h2>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee -a /etc/yum.repo.d/grafna.repo
[grafana]
name=grafana
baseurl=https://packages.grafana.com/oss/rpm
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://packages.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
</span><span class="no">EOF
</span><span class="nb">sudo </span>yum check-update
<span class="nb">sudo </span>yum <span class="nb">install </span>grafana

<span class="nb">sudo </span>systemctl daemon-reload

<span class="c"># default:</span>
<span class="nb">sudo </span>systemctl start grafana-server
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>grafana-server

<span class="c"># Change Admin password</span>
<span class="nb">sudo </span>grafana-cli admin reset-admin-password <span class="s2">"Password"</span>
</code></pre></div></div>
<hr />
<h2 id="install-prometheus">Install Prometheus</h2>
<blockquote>
  <p>Prometheus는 운영의 Owner를 가지고 있어 세부 사항 확인하여 진행</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Prometheus OS User Create</span>
<span class="c"># 서비스 계정이므로 로그인 불가능 하도록 쉘 변경</span>
<span class="nb">sudo </span>useradd <span class="nt">-m</span> <span class="nt">-r</span> <span class="nt">-s</span> /sbin/nologin <span class="nt">-d</span> /opt/prometheus prometheus

<span class="c"># prometheus archive file download</span>
wget <span class="s2">"https://github.com/prometheus/prometheus/releases/download/v2.36.2/prometheus-2.36.2.linux-amd64.tar.gz"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt
<span class="nb">tar</span> <span class="nt">-xvzf</span> prometheus-2.36.2.linux-amd64.tar.gz <span class="nt">-C</span> /opt
<span class="nb">mv</span> /opt/prometheus-2.36.2.linux-amd64 /opt/prometheus

<span class="nb">chown</span> <span class="nt">-R</span> prometheus.prometheus /opt/prometheus
<span class="nb">chmod</span> <span class="nt">-R</span> 640 /opt/prometheus
</code></pre></div></div>
<blockquote>
  <p>systemctl로 데몬을 관리 할 수 있도록 아래 과정을 진행</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee -a /usr/lib/systemd/system/prometheus.service
[Unit]
Description=Prometheus Server
Documentation=https://prometheus.io/docs/introduction/overview/
After=network.target

[Service]
User=prometheus
Restart=on-failure
ExecStart=/opt/prometheus/prometheus </span><span class="se">\</span><span class="sh">
  --config.file=/opt/prometheus/prometheus.yml </span><span class="se">\</span><span class="sh">
  --storage.tsdb.path=/opt/prometheus </span><span class="se">\</span><span class="sh">
  --web.enable-lifecycle

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>
<hr />
<h3 id="prometheus-configure">Prometheus Configure</h3>
<blockquote>
  <p>모니터링할 서버가 추가 될 때 마다 Prometheus Daemon을 재기동 해야 하는 상황이 생김. <br />
오랜 시간이 지난 후 봤을 때, 문제가 생긴건지 데몬이 재시작한건지 인지하기 어려운 상황이 생김 <br />
그에 따라 동적으로 설정 추가 및 변경이 가능하도록 파일 기반으로 수집할 서버 목록을 정리</p>
</blockquote>

<blockquote>
  <p>참고한 대시보드에서는 DB/OS 지표를 하나의 대시보드에서 모두 보고 있음, IP:Port 형식으로 데이터 수집 시 <br />
OS/DB 따로 봐야 하는 상황이 생김 그에 따라 IP:Port(Server:Port) 에서 “:Port” 부분을 분리하여 <br />
메타 데이터 저장</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee -a /etc/hosts
192.168.137.101 MYSQLDB01
192.168.137.102 MYSQLDB02
192.168.137.103 MYSQLDB03
</span><span class="no">EOF

</span><span class="nb">mkdir</span> <span class="nt">-p</span> /opt/prometheus/sd/mysql
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/prometheus/sd/mssql
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/prometheus/config_old
<span class="nb">mv</span> /opt/prometheus/prometheus.yml /opt/prometheus/config_old

<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee -a /opt/prometheus/prometheus.yml
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).
 
scrape_configs:
  - job_name: "mysql"
    file_sd_configs:
    - files:
      - 'sd/mysql/*.json'
    relabel_configs:
      - source_labels: ['__address__']
        regex:         "(.*):.*"
        target_label:  "instance"
        replacement:   "</span><span class="se">\$</span><span class="sh">{1}"
</span><span class="no">EOF

</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee -a /opt/prometheus/sd/mysql/static_config.yml
[
    {
        "targets": [
            "MYSQLDB01:9104",
            "MYSQLDB02:9104",
            "MYSQLDB03:9104"
        ],
        "labels": {
            "job": "mysql"
        }
    },
    {
        "targets": [
            "MYSQLDB01:9100",
            "MYSQLDB02:9100",
            "MYSQLDB03:9100"
        ],
        "labels": {
            "job": "mysql"
        }
    }
]
</span><span class="no">EOF

</span><span class="nb">chown</span> <span class="nt">-R</span> prometheus.prometheus /opt/prometheus
<span class="nb">chmod</span> <span class="nt">-R</span> 640 /opt/prometheus
</code></pre></div></div>

<h2 id="install-node-exporter">Install Node Exporter</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /opt
<span class="nb">sudo </span>useradd <span class="nt">-m</span> <span class="nt">-r</span> <span class="nt">-s</span> /sbin/nologin <span class="nt">-G</span> sudouser <span class="nt">-d</span> /opt/prometheus prometheus
wget <span class="s2">"https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz"</span>
<span class="nb">tar</span> <span class="nt">-xvzf</span> node_exporter-1.3.1.linux-amd64.tar.gz <span class="nt">-C</span> /opt/prometheus
<span class="nb">mv</span> /opt/prometheus/node_exporter-1.3.1.linux-amd64/ /opt/prometheus/node_exporter
<span class="nb">chown</span> <span class="nt">-R</span> prometheus.prometheus /opt/prometheus
<span class="nb">chmod</span> <span class="nt">-R</span> 700 /opt/prometheus
</code></pre></div></div>

<blockquote>
  <p>systemctl로 데몬을 관리 할 수 있도록 아래 과정을 진행</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | sudo tee -a /usr/lib/systemd/system/node_exporter.service
[Unit]
Description=Prometheus Node Exporter
Documentation=https://prometheus.io/docs/guides/node-exporter/
Wants=network.target
After=network.target

[Service]
User=prometheus
Restart=on-failure
ExecStart=/opt/prometheus/node_exporter/node_exporter

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>
<hr />
<h2 id="install-mysqld-exporter">Install mysqld Exporter</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="s2">"https://github.com/prometheus/mysqld_exporter/releases/download/v0.14.0/mysqld_exporter-0.14.0.linux-amd64.tar.gz"</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt
<span class="nb">tar</span> <span class="nt">-xvzf</span> mysqld_exporter-0.14.0.linux-amd64.tar.gz <span class="nt">-C</span> /opt/prometheus
<span class="nb">mv</span> /opt/prometheus/mysqld_exporter-0.14.0.linux-amd64/ /opt/prometheus/mysqld_exporter

<span class="nb">touch</span> /opt/prometheus/mysqld_exporter/my.cnf

<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | sudo tee -a /opt/prometheus/mysqld_exporter/my.cnf
[client]
port=3306
socket= /tmp/mysql.sock
default-character-set=utf8
user=export_service
password=Grafana@@0707
</span><span class="no">EOF
</span><span class="nb">chown</span> <span class="nt">-R</span> prometheus.prometheus /opt/prometheus
<span class="nb">chmod</span> <span class="nt">-R</span> 700 /opt/prometheus
<span class="nb">chmod </span>600 /opt/prometheus/mysqld_exporter/my.cnf

</code></pre></div></div>
<hr />
<blockquote>
  <p>mysqld exporter 는 DB 계정이 필요하며 필요한 권한은 아래와 같다.</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="n">mysql</span> <span class="c1">--login-path=localhost</span>

<span class="k">CREATE</span> <span class="k">USER</span> <span class="nv">`prometh_service`</span><span class="o">@</span><span class="nv">`localhost`</span> <span class="n">idneitifed</span> <span class="k">by</span> <span class="nv">""</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="n">PROCESS</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">CLIENT</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`prometh_service`</span><span class="o">@</span><span class="nv">`localhost`</span><span class="p">;</span>
</code></pre></div></div>
<blockquote>
  <p>DB 계정이 생성이 완료되었으면 systemctl로 데몬을 관리 할 수 있도록 아래 과정을 진행 <br />
옵션의 경우 mysqld_exporter github에서 확인할 수 있다.
—</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> | sudo tee -a /usr/lib/systemd/system/mysqld_exporter.service
[Unit]
Description=Prometheus MySQL Exporter
After=network.target

[Service]
Type=simple
Restart=always
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/mysqld_exporter/mysqld_exporter </span><span class="se">\</span><span class="sh">
--config.my-cnf=/opt/prometheus/mysqld_exporter/my.cnf </span><span class="se">\</span><span class="sh">
--web.listen-address=0.0.0.0:9104 </span><span class="se">\</span><span class="sh">
--collect.global_status </span><span class="se">\</span><span class="sh">
--collect.global_variables </span><span class="se">\</span><span class="sh">
--collect.info_schema.clientstats </span><span class="se">\</span><span class="sh">
--collect.info_schema.innodb_metrics </span><span class="se">\</span><span class="sh">
--collect.info_schema.innodb_tablespaces </span><span class="se">\</span><span class="sh">
--collect.info_schema.innodb_cmp </span><span class="se">\</span><span class="sh">
--collect.info_schema.innodb_cmpmem </span><span class="se">\</span><span class="sh">
--collect.info_schema.processlist </span><span class="se">\</span><span class="sh">
--collect.info_schema.processlist.min_time=0 </span><span class="se">\</span><span class="sh">
--collect.info_schema.query_response_time </span><span class="se">\</span><span class="sh">
--collect.info_schema.replica_host </span><span class="se">\</span><span class="sh">
--collect.info_schema.tables </span><span class="se">\</span><span class="sh">
--collect.info_schema.tables.databases=‘*’ </span><span class="se">\</span><span class="sh">
--collect.info_schema.tablestats </span><span class="se">\</span><span class="sh">
--collect.info_schema.schemastats </span><span class="se">\</span><span class="sh">
--collect.info_schema.userstats </span><span class="se">\</span><span class="sh">
--collect.mysql.user </span><span class="se">\</span><span class="sh">
--collect.perf_schema.eventsstatements </span><span class="se">\</span><span class="sh">
--collect.perf_schema.eventsstatements.digest_text_limit=120 </span><span class="se">\</span><span class="sh">
--collect.perf_schema.eventsstatements.limit=250 </span><span class="se">\</span><span class="sh">
--collect.perf_schema.eventsstatements.timelimit=86400 </span><span class="se">\</span><span class="sh">
--collect.perf_schema.eventsstatementssum </span><span class="se">\</span><span class="sh">
--collect.perf_schema.eventswaits </span><span class="se">\</span><span class="sh">
--collect.perf_schema.file_events </span><span class="se">\</span><span class="sh">
--collect.perf_schema.file_instances </span><span class="se">\</span><span class="sh">
--collect.perf_schema.file_instances.remove_prefix=false </span><span class="se">\</span><span class="sh">
--collect.perf_schema.indexiowaits </span><span class="se">\</span><span class="sh">
--collect.perf_schema.memory_events </span><span class="se">\</span><span class="sh">
--collect.perf_schema.memory_events.remove_prefix=false </span><span class="se">\</span><span class="sh">
--collect.perf_schema.tableiowaits </span><span class="se">\</span><span class="sh">
--collect.perf_schema.tablelocks </span><span class="se">\</span><span class="sh">
--collect.perf_schema.replication_group_members </span><span class="se">\</span><span class="sh">
--collect.perf_schema.replication_group_member_stats </span><span class="se">\</span><span class="sh">
--collect.perf_schema.replication_applier_status_by_worker </span><span class="se">\</span><span class="sh">
--collect.slave_status </span><span class="se">\</span><span class="sh">
--collect.slave_hosts </span><span class="se">\</span><span class="sh">
--collect.heartbeat </span><span class="se">\</span><span class="sh">
--collect.heartbeat.database=true </span><span class="se">\</span><span class="sh">
--collect.heartbeat.table=true </span><span class="se">\</span><span class="sh">
--collect.heartbeat.utc

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>

<h2 id="daemon-run">Daemon Run</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload

systemctl start mysqld_exporter
systemctl <span class="nb">enable </span>mysqld_exporter

systemctl start node_exporter
systemctl <span class="nb">enable </span>node_exporter

netstat <span class="nt">-nalp</span> | <span class="nb">grep </span>910
tcp6       0      0 :::9100                 :::<span class="k">*</span>                    LISTEN      13007/node_exporter
tcp6       0      0 :::9104                 :::<span class="k">*</span>                    LISTEN      13114/mysqld_export
</code></pre></div></div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
